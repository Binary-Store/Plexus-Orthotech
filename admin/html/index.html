<!DOCTYPE html>
<html lang="en">
<!-- Begin Head -->

<head>
    <!--=== Required meta tags ===-->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!--=== custom css ===-->
    <link href="../../assets/fonts/metropolis.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../assets/css/animate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" type="image/png" href="../../assets/images/favicon.png" />
    <link rel="stylesheet" href="../../assets/css/style.css" />

    <link rel="stylesheet" href="../css/index.css">
    <!--=== custom css ===-->
    <title>Plexus Orthotech - Admin pannel</title>
    <script src="../js/index.js"></script>
    <script>
        //TODO : Add this script to all admin pages once login functionlity compleate
        document.addEventListener('DOMContentLoaded', function () {
            checkCookieAndRedirect('adminToken', './login.html');
        });
    </script>
    <style>
        #product_image {
            display: none;
        }
    </style>
</head>

<body>

    <div class="hc-header-wrapper hc-sections">
        <div class=" hc-container">
            <div class="hc-navbar-wrapper">
                <div class="hc-brand-logo">
                    <a href="../../index.html">
                        <img src="../../assets/images/logo.png" class="hc-logo" alt="logo" />
                    </a>
                    <div class="hc-toggle-btn">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div class="hc-navbar-menu">
                    <ul>
                        <li class="responsive-logo">
                            <a href="#">
                                <img src="../../assets/images/logo.png" />
                            </a>
                        </li>
                        <li class="active">
                            <a href="#">Product</a>
                        </li>
                        <li>
                            <a href="./category.html">Category</a>
                        </li>
                        <li>
                            <a href="./careers.html">Careers</a>
                        </li>
                        <li>
                            <a href="./video.html">Video</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="hc-department-wrapper hc-sections pc-container">
        <div class="d-block d-lg-flex justify-content-start gap-3 m-3">
            <div class="input-group input-grop-container mb-3">
                <input type="text" id="search" class="form-control">
                <div class="input-group-append"><button class="btn btn-primary" onclick="searchResult()"><i
                            class="fas fa-search"></i></button>
                </div>
            </div>
            <!-- Button trigger modal -->
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#productModal">
                add Product
            </button>
            <!-- Modal -->
            <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="productModalLabel">Add Product</h1>
                            <button type="button" class="btn-close" id="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Form -->
                            <form class="needs-validation" id="product-form" novalidate>
                                <p class="text-danger" id="product-form-error"></p>
                                <input type="number" class="d-none" name="product_id" id="product_id">
                                <div class="mb-3 col-12">
                                    <label for="product-name" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" name="product_name" id="product_name"
                                        required>
                                    <div class="invalid-feedback">
                                        Please enter a valid product name.
                                    </div>
                                </div>
                                <div class="mb-3 col-12">
                                    <label for="product-category" class="form-label">Category</label>
                                    <select class="form-select border" name="category_id" id="category_id" required>
                                        <option selected disabled value="">Select Category ...</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a Category
                                    </div>
                                </div>
                                <div class="mb-3 col-12">
                                    <label for="product-subcategory" class="form-label">Sub Category</label>
                                    <select class="form-select border" name="subcategory_id" id="subcategory_id">
                                        <option selected disabled value="">Choose...</option>
                                        <option>1</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a Sub Category
                                    </div>
                                </div>
                                <div class="mb-3 mt-1 col-12">
                                    <label for="product-img" class="form-label">Image</label>
                                    <div class="d-flex justify-content-start gap-2">
                                        <button type="button" id="customButton">Upload File</button>
                                        <input type="file" class="form-control" name="product_image" id="product_image">
                                        <input type="text" id="fileName" readonly>
                                    </div>
                                    <div class="invalid-feedback">
                                        plese upload a image
                                    </div>
                                </div>
                                <button type="submit" id="submit" class="btn btn-primary">create</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-around flex-wrap " id="product-container">
        </div>
    </div>

    <script src="../../assets/js/jquery.min.js"></script>
    <script src="../../assets/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const url = 'http://localhost/Plexus-Orthotech/admin/includes/product.php'
        let productImagUrl = 'http://localhost/Plexus-Orthotech/admin/images'
        let product = []
        let category = []
        let isEdit = false
        const editUrl = 'http://localhost/Plexus-Orthotech/admin/includes/editProduct.php'

        let form = document.getElementById('product-form')

        // close model and reset form
        $('#productModal').on('hidden.bs.modal', function (e) {
            form.classList.remove('was-validated')
            // reset form
            form.reset()
            document.getElementById('submit').innerText = 'Create'
        })

        form.addEventListener('submit', function (event) {
            if (form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()

                let formData = new FormData(form)

                const token = getCookie('adminToken')

                $.ajax({
                    url: `${isEdit ? editUrl : url}`,
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Custom-Header': 'CustomValue'
                    },
                    success: function (data) {
                        if (data.success) {
                            if (isEdit) {
                                product = product.filter(element => element.id != data.product.id)
                            }
                            product = [data.product, ...product]
                            renderProduct(product)
                            // close modal
                            $('#productModal').modal('hide')
                            document.getElementById('submit').innerText = 'Submit'

                            Swal.fire({
                                icon: 'success',
                                title: `Product ${isEdit ? 'updated' : 'added'} successfully`,
                                showConfirmButton: false,
                                timer: 1500
                            })
                            isEdit = false

                        }
                    },
                    error: function (error) {
                        console.log(error)
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.responseJSON.message
                        })
                    }
                })
            }
            else {
                console.log("hit")
                form.classList.add('was-validated')
                event.preventDefault()
                event.stopPropagation()
            }
        }
        )

        $.ajax({
            url: 'http://localhost/Plexus-Orthotech/admin/includes/category.php',
            type: 'GET',
            success: function (data) {
                category = data.categories
                renderCategory(category)
            },
            error: function (error) {
                console.log(error)
            }
        })

        $.ajax({
            url: url,
            type: 'GET',
            success: function (data) {
                product = data.products
                renderProduct(product)
            },
            error: function (error) {
                console.log(error)
            }
        })

        function renderCategory(category) {
            let category_id = document.getElementById('category_id')
            category.forEach(element => {
                let option = document.createElement('option')
                option.value = element.id
                option.innerText = element.name
                category_id.appendChild(option)
            });
            category_id.addEventListener('change', function () {
                renderSubCategory(this.value); // Render subcategories based on selected category
            });

        }
        function renderSubCategory(id) {
            let product_subcategory = document.getElementById('subcategory_id')
            // Clear previous subcategories
            product_subcategory.innerHTML = '<option selected disabled value="">Choose...</option>'
            let catgoryIndex = category.findIndex(element => element.id == id)
            let subcategory = category[catgoryIndex].subcategories
            subcategory && subcategory.forEach(element => {
                let option = document.createElement('option')
                option.value = element.id
                option.innerText = element.name
                subcategory_id.appendChild(option)
            });

        }

        document.getElementById('customButton').addEventListener('click', function () {
            document.getElementById('product_image').click();
        });

        document.getElementById('product_image').addEventListener('change', function (event) {
            var fileInput = event.target;
            var fileName = fileInput.files[0] ? fileInput.files[0].name : '';
            document.getElementById('fileName').value = fileName;
        });

        function renderProduct(product) {
            let container = document.getElementById("product-container")
            container.innerHTML = ''
            product.forEach(element => {
                let productCard = document.createElement('div')
                productCard.classList.add('product-card')
                productCard.innerHTML = `
                <img src="${productImagUrl}/${element.image}" alt="Product Image">
                <h3>${element.name}</h3>
                <p>Category:${element.category}</p>
                <p>Subcategory: ${element.subcategory ? element.subcategory : '-'}</p>
                <button class="edit-product-btn" onClick="editProduct(${element.id})">Edit</button>
                <button class="delete-product-btn" onClick='deleteCard(${element.id})'>Delete</button>`
                container.innerHTML = container.innerHTML + productCard.outerHTML;
            });
        }

        function deleteCard(id) {
            const token = getCookie('adminToken')
            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    const product_id = Number(id)
                    $.ajax({
                        url: `${url}/${product_id}`,
                        type: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        success: function (data) {
                            product = product.filter(element => element.id != id)
                            renderProduct(product)
                            Swal.fire({
                                icon: 'success',
                                title: 'Product deleted successfully',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        },
                        error: function (error) {
                            console.log(error)
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: error.responseJSON.message
                            })
                        }
                    })
                }
            });

        }

        function searchResult() {
            let search = document.getElementById('search').value;
            search = search.toLowerCase();
            if (search === '') {
                renderProduct(product)
            } else {
                const filteredProduct = product.filter(item =>
                    item.category.toLowerCase().includes(search) ||
                    (item.subcategory && item.subcategory.toLowerCase().includes(search)) ||
                    item.name.toLowerCase().includes(search)
                );
                renderProduct(filteredProduct)
            }
        }

        function editProduct(id) {
            // open model and fill form with product details
            $('#productModal').modal('show')
            const productIndex = product.findIndex(element => element.id == id)
            const productDetails = product[productIndex]
            document.getElementById('product_name').value = productDetails.name
            document.getElementById('category_id').value = productDetails.category_id
            renderSubCategory(productDetails.category_id)
            document.getElementById('subcategory_id').value = productDetails.subcategory_id
            document.getElementById('fileName').value = productDetails.image
            document.getElementById('submit').innerText = 'Update'
            document.getElementById('product_id').value = productDetails.id
            isEdit = true
        }
    </script>

</body>

</html>