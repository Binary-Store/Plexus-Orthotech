<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Custom CSS -->
  <link href="../../assets/fonts/metropolis.css" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../assets/css/animate.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="shortcut icon" type="image/png" href="../../assets/images/favicon.png">
  <link rel="stylesheet" href="../../assets/css/style.css">
  <link rel="stylesheet" href="../css/index.css">

  <title>Plexus Orthotech - Admin Panel - Video</title>
  <script src="../js/index.js"></script>
  <script>
      // this script redirect to login page if not login 
    document.addEventListener('DOMContentLoaded', function () {
      checkCookieAndRedirect('adminToken', '../index.html');
    });
  </script>
</head>

<body>

  <div class="hc-header-wrapper hc-sections">
    <div class="hc-container">
      <div class="hc-navbar-wrapper">
        <div class="hc-brand-logo">
          <a href="../../index.html">
            <img src="../../assets/images/logo.png" class="hc-logo" alt="logo">
          </a>
          <div class="hc-toggle-btn">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <div class="hc-navbar-menu">
          <ul>
            <li class="responsive-logo">
              <a href="../../index.html">
                <img src="../../assets/images/logo.png" alt="logo">
              </a>
            </li>
            <li class="active">
              <a href="./index.html">Product</a>
            </li>
            <li>
              <a href="./category.html">Category</a>
            </li>
            <li>
              <a href="./careers.html">Careers</a>
            </li>
            <li>
              <a href="#">Video</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="hc-department-wrapper hc-sections pc-container">
    <div class="d-flex justify-content-center">
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#videoModel">
        add Video
      </button>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="videoModel" tabindex="-1" aria-labelledby="videoModel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Add Video</h1>
            <button type="button" class="btn-close" id="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="add_video_form" class="needs-validation" novalidate>
              <div class=" mb-3 col-12">
                <label for="video_url" class="form-label">Video Link</label>
                <input type="text" class="form-control" name="video_url" id="video_url" required>
                <div class="invalid-feedback">
                  Please provide a valid video link.
                </div>

                <button type="submit" id="submit" class="btn btn-primary mt-4">Add</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row g-3" id="videoContainer">
      <!-- Video Cards -->

    </div>
  </div>
  </div>

  <!-- Scripts -->
  <script src="../../assets/js/jquery.min.js"></script>
  <script src="../../assets/js/bootstrap.min.js"></script>
  <script src="../../assets/js/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../assets/js/custom.js"></script>

  <script>
    //add video form 
    const form = document.getElementById('add_video_form');
    const url = '../includes/video.php'
    let videos = []

    $('#videoModel').on('hidden.bs.modal', function (e) {
      form.classList.remove('was-validated')
      // reset form
      form.reset()
      document.getElementById('submit').innerText = 'Add'
    })

    form.addEventListener('submit', (e) => {
      event.preventDefault()
      event.stopPropagation()
      if (form.checkValidity()) {
        //get input data as json
        const video_url = document.getElementById('video_url').value;
        const data = {
          video_url: video_url
        }
        const token = getCookie('adminToken')

        $.ajax({
          url: url,
          type: "POST",
          data: JSON.stringify(data),
          headers: {
            'Authorization': `Bearer ${token}`,
            'Custom-Header': 'CustomValue'
          },
          success: function (response) {
            videos = [response.videos, ...videos]
            renderVideoCard(video_url)
            Swal.fire({
              icon: 'success',
              title: 'Video Added successfully',
              showConfirmButton: false,
              timer: 1500
            })
            $('#videoModel').modal('hide');
          },
          error: function (error) {
           if (error.status === 401) {
              Swal.fire({
                icon: 'error',
                title: 'Unauthorized',
                text: 'Your session has expired, please log in again.',
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = '../index.html'; // Redirect to the login page

                }
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.responseJSON.message
              });
            }
          }
        });

      }
      form.classList.add('was-validated');
    });

    $.ajax({
      url: url,
      type: "GET",
      success: function (response) {
        videos = response.videos
        renderVideoCard(videos)
      },
      error: function (error) {
        console.log(error)
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: error.responseJSON.message
        })
      }
    });

    function renderVideoCard(video) {
      const videoContainer = document.getElementById('videoContainer');
      videoContainer.innerHTML = '';
      videos.forEach(element => {
        const videoCard = document.createElement('div');
        videoCard.classList.add('col-12', 'col-md-6');
        videoCard.innerHTML = `
          <div class="video-card bg-white p-3">
            <div class="w-100 d-flex justify-content-center">
              <iframe class="iframe-tag rounded-2" src='${element.link}'
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
            <div class="action d-flex align-middle justify-content-start gap-4 mt-3">
              <img class="border" src="../../assets/images/admin/delete.svg" onClick="deleteVideoCard(${element.id})" alt="delete icon">
            </div>
          </div>`;
        videoContainer.appendChild(videoCard);
      });


    }


    function deleteVideoCard(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!"
      }).then((result) => {
        if (result.isConfirmed) {
          const token = getCookie('adminToken')

          // call delete api 
          $.ajax({
            url: `${url}/${id}`,
            type: "DELETE",
            headers: {
              'Authorization': `Bearer ${token}`,
              'Custom-Header': 'CustomValue'
            },
            success: function (response) {
              videos = videos.filter(video => video.id != `${id}`)
              renderVideoCard(videos)
              Swal.fire({
                title: "Deleted!",
                text: "Your file has been deleted.",
                icon: "success"
              });
            },
            error: function (error) {
              if (error.status === 401) {
              Swal.fire({
                icon: 'error',
                title: 'Unauthorized',
                text: 'Your session has expired, please log in again.',
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = '../index.html'; // Redirect to the login page

                }
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.responseJSON.message
              });
            }
            }
          });
        }
      });
    }
    //get form data 
  </script>
</body>

</html>