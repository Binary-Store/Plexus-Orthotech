<!DOCTYPE html>
<html lang="en">
<!-- Begin Head -->

<head>
  <!--=== Required meta tags ===-->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!--=== custom css ===-->
  <link href="../../assets/fonts/metropolis.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="shortcut icon" type="image/png" href="../../assets/images/favicon.png" />
  <link rel="stylesheet" href="../../assets/css/style.css" />

  <link rel="stylesheet" href="../css/index.css">
  <!--=== custom css ===-->
  <title>Plexus Orthotech - Admin pannel - career</title>
  <script src="../js/index.js"></script>
  <script>
    // this script redirect to login page if not login 
    document.addEventListener('DOMContentLoaded', function () {
      checkCookieAndRedirect('adminToken', '../index.html');
    });
  </script>
</head>

<body>

  <div class="hc-header-wrapper hc-sections">
    <div class=" hc-container">
      <div class="hc-navbar-wrapper">
        <div class="hc-brand-logo">
          <a href="../../index.html">
            <img src="../../assets/images/logo.png" class="hc-logo" alt="logo" />
          </a>
          <div class="hc-toggle-btn">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <div class="hc-navbar-menu">
          <ul>
            <li class="responsive-logo">
              <a href="../../index.html">
                <img src="../../assets/images/logo.png" />
              </a>
            </li>
            <li>
              <a href="./index.html">Product</a>
            </li>
            <li>
              <a href="./category.html">Category</a>
            </li>
            <li class="active">
              <a href="#">Careers</a>
            </li>
            <li>
              <a href="./video.html">Video</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="hc-department-wrapper hc-sections pc-container">
    <button class="btn btn-primary ms-4 mb-3" data-bs-toggle="modal" data-bs-target="#openingPositionModel">
      add Opening Position
    </button>

    <!-- Modal -->
    <div class="modal fade" id="openingPositionModel" tabindex="-1" aria-labelledby="openingPositionModelLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="openingPositionModelLabel">Add Opening Position</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form class="needs-validation" id="openingPosition-form" novalidate>
              <div class=" mb-3 col-12">
                <label for="position_name" class="form-label">Position Name</label>
                <input type="text" class="form-control border" id="position_name" required>
                <div class="invalid-feedback">
                  Please enter a valid position name.
                </div>
              </div>
              <div class=" mb-3 col-12">
                <label for="position_address" class="form-label">Position Name</label>
                <input type="text" class="form-control border" id="position_address" required>
                <div class="invalid-feedback">
                  Please enter a valid address name.
                </div>
              </div>
              <button type="submit" id="submitPosition" class="btn btn-primary">Add</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive m-4">
      <table class="table table-hover main-table">
        <thead>
          <tr>
            <th>No</th>
            <th>Position Name</th>
            <th>Address</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <script src="../../assets/js/jquery.min.js"></script>
  <script src="../../assets/js/bootstrap.min.js"></script>
  <script src="../../assets/js/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../../assets/js/custom.js"></script>
  <script>
    const url = '../includes/career.php'
    let careers = [];
    let positionId = -1;
    $.ajax({
      url: url,
      type: 'GET',
      success: function (data) {
        careers = data.careers;
        renderCarrer(careers);
      },
      error: function (error) {
        console.log(error);
      }
    });
    // when form submit that time ajax call
    $('#openingPosition-form').submit(function (e) {
      e.preventDefault();
      // also check validation
      if (!this.checkValidity()) {
        e.stopPropagation();
        this.classList.add('was-validated');
      } else {

        const token = getCookie('adminToken')
        const position_name = $('#position_name').val();
        const position_address = $('#position_address').val();
        const subcategory_id = $('#position-id').val();
        const data = {
          position_name,
          position_address
        }
        $.ajax({
          url: positionId === -1 ? url : `${url}/${positionId}`,
          type: positionId === -1 ? 'POST' : 'PUT',
          data: JSON.stringify(data),
          headers: {
            'Authorization': `Bearer ${token}`,
            'Custom-Header': 'CustomValue'
          },
          success: function (response) {
            if (positionId !== -1) {
              // finde index
              const index = careers.findIndex(carrer => carrer.id == `${positionId}`);
              careers[index] = response.career;

            } else {
              careers.push(response.career);
            }
            renderCarrer(careers);
            $('#position_name').val('');
            $('#position_address').val('');
            $('#position-id').val('');
            $('#openingPositionModel').modal('hide');
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: positionId === -1 ? 'Position added successfully' : 'Position updated successfully'
            })
            positionId = -1;
          },
          error: function (error) {
            if (error.status === 401) {
              Swal.fire({
                icon: 'error',
                title: 'Unauthorized',
                text: 'Your session has expired, please log in again.',
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = '../index.html'; // Redirect to the login page
                }
              });
            } else {
              console.log(error);
              Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.responseJSON.message
              });
            }
          }
        });
      }
    });

    function editPosition(id, event) {
      const carrer = careers.find(carrer => carrer.id == id);
      $('#position_name').val(carrer.name);
      $('#position_address').val(carrer.address);
      $('#openingPositionModel').modal('show');
      positionId = Number(id);
      event.stopPropagation();
    }

    // when user click close btn of model that time form should reset
    $('#openingPositionModel').on('hidden.bs.modal', function (e) {
      $('#openingPosition-form').removeClass('was-validated');
      $('#position_name').val('');
      $('#position_address').val('');
      $('#position-id').val('');
      positionId = -1;
    });

    // make renderCarrer function
    function renderCarrer(carrers) {
      const tbody = document.querySelector('.main-table tbody');
      tbody.innerHTML = '';
      carrers.forEach((carrer, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="align-middle">${index + 1}</td>
          <td class="align-middle">${carrer.name}</td>
          <td class="align-middle">${carrer.address}</td>
          <td>
            <div class="action d-flex align-middle justify-content-start gap-4">
              <img src="../../assets/images/admin/edit.svg" alt="edit icon" onclick="editPosition(${carrer.id},event)">
              <img src="../../assets/images/admin/delete.svg" onClick="deletePosition(${carrer.id})" alt="delete icon">
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // delete carrer
    function deletePosition(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!"
      }).then((result) => {
        if (result.isConfirmed) {
          const token = getCookie('adminToken')

          // call delete api 
          $.ajax({
            url: `${url}/${id}`,
            type: "DELETE",
            headers: {
              'Authorization': `Bearer ${token}`,
              'Custom-Header': 'CustomValue'
            },
            success: function (response) {
              careers = careers.filter(carrer => carrer.id != `${id}`)
              renderCarrer(careers)
              Swal.fire({
                title: "Deleted!",
                text: "Your file has been deleted.",
                icon: "success"
              });
            },
            error: function (error) {
              if (error.status === 401) {
                Swal.fire({
                  icon: 'error',
                  title: 'Unauthorized',
                  text: 'Your session has expired, please log in again.',
                  confirmButtonText: 'OK'
                }).then((result) => {
                  if (result.isConfirmed) {
                    window.location.href = '../index.html'; // Redirect to the login page

                  }
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Oops...',
                  text: error.responseJSON.message
                });
              }
            }
          });
        }
      });
    }
  </script>

</body>

</html>